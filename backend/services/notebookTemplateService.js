import Notebook from "../models/Notebook.js";
import PlantTemplate from "../models/PlantTemplate.js";
import Guide from "../models/Guide.js";
import { AppError } from "../utils/AppError.js";

/**
 * Service xá»­ lÃ½ tÃ­ch há»£p Notebook vá»›i PlantTemplate
 */

// Láº¥y template phÃ¹ há»£p vá»›i notebook (dá»±a trÃªn guide's plant_group)
export const getTemplateForNotebook = async (notebookId) => {
  const notebook = await Notebook.findById(notebookId).populate("guide_id");

  if (!notebook) {
    throw new AppError("KhÃ´ng tÃ¬m tháº¥y nháº­t kÃ½", 404);
  }

  // Náº¿u Ä‘Ã£ cÃ³ template_id, tráº£ vá» template Ä‘Ã³
  if (notebook.template_id) {
    const template = await PlantTemplate.findById(notebook.template_id);
    return template;
  }

  // Náº¿u chÆ°a cÃ³ template, tÃ¬m template active phÃ¹ há»£p vá»›i plant_group cá»§a guide
  if (notebook.guide_id && notebook.guide_id.plant_group) {
    const template = await PlantTemplate.findOne({
      plant_group: notebook.guide_id.plant_group,
      is_active: true,
    }).sort({ usage_count: -1 });

    return template;
  }

  return null;
};

// GÃ¡n template cho notebook
export const assignTemplateToNotebook = async (notebookId, templateId) => {
  const notebook = await Notebook.findById(notebookId);
  const template = await PlantTemplate.findById(templateId);

  if (!notebook) {
    throw new AppError("KhÃ´ng tÃ¬m tháº¥y nháº­t kÃ½", 404);
  }

  if (!template) {
    throw new AppError("KhÃ´ng tÃ¬m tháº¥y template", 404);
  }

  notebook.template_id = templateId;

  // Khá»Ÿi táº¡o stages_tracking
  notebook.stages_tracking = template.stages.map((stage, index) => ({
    stage_number: index + 1,
    stage_name: stage.name, // â† FIX: DÃ¹ng 'name' tá»« PlantTemplate schema
    started_at: index === 0 ? notebook.planted_date : null,
    is_current: index === 0,
  }));

  notebook.current_stage = 1;

  // âœ… TÃ­nh progress dá»±a trÃªn cÃ¡c stage Ä‘Ã£ hoÃ n thÃ nh (stage 1 chÆ°a hoÃ n thÃ nh = 0%) (now async)
  await notebook.updateProgress(template.stages);

  await notebook.save();

  // TÄƒng usage_count cá»§a template
  template.usage_count += 1;
  await template.save();

  // Generate daily checklist cho stage Ä‘áº§u tiÃªn
  await generateDailyChecklist(notebookId);

  return notebook;
};

// TÃ­nh stage hiá»‡n táº¡i dá»±a trÃªn sá»‘ ngÃ y Ä‘Ã£ trá»“ng
export const calculateCurrentStage = async (notebookId) => {
  const notebook = await Notebook.findById(notebookId).populate("template_id");

  if (!notebook || !notebook.template_id) {
    return null;
  }

  const template = notebook.template_id;
  const daysPlanted = notebook.current_day;

  // TÃ¬m stage tÆ°Æ¡ng á»©ng vá»›i sá»‘ ngÃ y Ä‘Ã£ trá»“ng
  const stageInfo = template.getStageByDay(daysPlanted);

  if (stageInfo && stageInfo.stage_number !== notebook.current_stage) {
    // Cáº­p nháº­t stage má»›i
    await updateCurrentStage(notebookId, stageInfo.stage_number);
  }

  return stageInfo;
};

// Cáº­p nháº­t stage hiá»‡n táº¡i
export const updateCurrentStage = async (notebookId, newStageNumber) => {
  const notebook = await Notebook.findById(notebookId).populate("template_id");

  if (!notebook || !notebook.template_id) {
    throw new AppError("KhÃ´ng tÃ¬m tháº¥y nháº­t kÃ½ hoáº·c template", 404);
  }

  const template = notebook.template_id;

  if (newStageNumber > template.stages.length) {
    throw new AppError("Sá»‘ stage khÃ´ng há»£p lá»‡", 400);
  }

  // HoÃ n thÃ nh stage cÅ©
  const oldStageIndex = notebook.stages_tracking.findIndex(
    (s) => s.stage_number === notebook.current_stage
  );
  if (oldStageIndex !== -1) {
    notebook.stages_tracking[oldStageIndex].is_current = false;
    notebook.stages_tracking[oldStageIndex].completed_at = new Date();
  }

  // Báº¯t Ä‘áº§u stage má»›i
  const newStageIndex = notebook.stages_tracking.findIndex(
    (s) => s.stage_number === newStageNumber
  );
  if (newStageIndex !== -1) {
    notebook.stages_tracking[newStageIndex].is_current = true;
    notebook.stages_tracking[newStageIndex].started_at = new Date();
  }

  notebook.current_stage = newStageNumber;

  // âœ… Update progress: chá»‰ tÃ­nh cÃ¡c stage Ä‘Ã£ completed (now async)
  await notebook.updateProgress(template.stages);

  await notebook.save();

  // Generate láº¡i checklist cho stage má»›i
  await generateDailyChecklist(notebookId);

  return notebook;
};

// Táº¡o daily checklist tá»« template's autogenerated_tasks
export const generateDailyChecklist = async (notebookId) => {
  const notebook = await Notebook.findById(notebookId).populate("template_id");

  if (!notebook || !notebook.template_id) {
    return null;
  }

  const template = notebook.template_id;
  const currentStage = template.stages.find(
    (s, index) => index + 1 === notebook.current_stage
  );

  if (!currentStage) {
    return null;
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // Kiá»ƒm tra náº¿u Ä‘Ã£ generate hÃ´m nay
  if (
    notebook.last_checklist_generated &&
    notebook.last_checklist_generated.setHours(0, 0, 0, 0) === today.getTime()
  ) {
    return notebook.daily_checklist;
  }

  // Lá»c tasks theo frequency (náº¿u task lÃ  daily hoáº·c Ä‘áº¿n ngÃ y thá»±c hiá»‡n)
  const daysInStage =
    Math.floor(notebook.current_day) - currentStage.start_day + 1;

  const newChecklist = currentStage.autogenerated_tasks
    .filter((task) => {
      if (task.frequency === "daily") return true;
      if (task.frequency === "every_2_days") return daysInStage % 2 === 0;
      if (task.frequency === "every_3_days") return daysInStage % 3 === 0;
      if (task.frequency === "weekly") return daysInStage % 7 === 0;
      return false;
    })
    .map((task) => ({
      task_name: task.task_name,
      description: task.description,
      priority: task.priority,
      frequency: task.frequency,
      is_completed: false,
    }));

  notebook.daily_checklist = newChecklist;
  notebook.last_checklist_generated = today;
  await notebook.save();

  return newChecklist;
};

// ÄÃ¡nh dáº¥u hoÃ n thÃ nh task trong checklist
export const completeChecklistTask = async (notebookId, taskName) => {
  const notebook = await Notebook.findById(notebookId).populate("template_id");

  if (!notebook) {
    throw new AppError("KhÃ´ng tÃ¬m tháº¥y nháº­t kÃ½", 404);
  }

  const task = notebook.daily_checklist.find((t) => t.task_name === taskName);

  if (!task) {
    throw new AppError("KhÃ´ng tÃ¬m tháº¥y cÃ´ng viá»‡c", 404);
  }

  // Toggle logic: náº¿u Ä‘Ã£ hoÃ n thÃ nh thÃ¬ chuyá»ƒn vá» chÆ°a hoÃ n thÃ nh, vÃ  ngÆ°á»£c láº¡i
  task.is_completed = !task.is_completed;
  task.completed_at = task.is_completed ? new Date() : null;

  // Track task completion trong stage_tracking
  const currentStageTracking = notebook.stages_tracking.find(
    (s) => s.stage_number === notebook.current_stage
  );

  if (currentStageTracking) {
    if (task.is_completed) {
      // ThÃªm vÃ o completed_tasks náº¿u chÆ°a cÃ³
      const alreadyCompleted = currentStageTracking.completed_tasks?.some(
        (t) => t.task_name === taskName
      );

      if (!alreadyCompleted) {
        if (!currentStageTracking.completed_tasks) {
          currentStageTracking.completed_tasks = [];
        }
        currentStageTracking.completed_tasks.push({
          task_name: taskName,
          completed_at: new Date(),
        });
      }
    } else {
      // XÃ³a khá»i completed_tasks náº¿u uncheck
      if (currentStageTracking.completed_tasks) {
        currentStageTracking.completed_tasks =
          currentStageTracking.completed_tasks.filter(
            (t) => t.task_name !== taskName
          );
      }
    }
  }

  // âœ… Update progress: tÃ­nh cáº£ stage hiá»‡n táº¡i (now async)
  if (notebook.template_id && notebook.template_id.stages) {
    await notebook.updateProgress(notebook.template_id.stages);
    console.log(`ðŸ“Š Progress updated: ${notebook.progress}%`);
    console.log(
      `ðŸ“‹ Completed tasks in current stage: ${
        currentStageTracking?.completed_tasks?.length || 0
      }`
    );
  }

  // âœ… Cáº­p nháº­t daily_progress cho ngÃ y hÃ´m nay
  if (currentStageTracking) {
    const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD

    console.log(
      `ðŸ” Checking daily_logs for stage ${notebook.current_stage} on ${today}`
    );

    // TÃ¬m hoáº·c táº¡o daily_log cho ngÃ y hÃ´m nay
    let dailyLog = currentStageTracking.daily_logs?.find(
      (log) => log.date?.toISOString().split("T")[0] === today
    );

    if (!dailyLog) {
      if (!currentStageTracking.daily_logs) {
        currentStageTracking.daily_logs = [];
      }
      dailyLog = {
        date: new Date(),
        daily_progress: 0,
      };
      currentStageTracking.daily_logs.push(dailyLog);
      console.log(`âž• Created new daily_log for ${today}`);
    } else {
      console.log(
        `âœ… Found existing daily_log for ${today}: ${dailyLog.daily_progress}%`
      );
    }

    // TÃ­nh daily_progress dá»±a trÃªn tasks cá»§a ngÃ y hÃ´m nay
    const todayTasks = notebook.daily_checklist || [];
    const completedTodayTasks = todayTasks.filter((t) => t.is_completed).length;
    const totalTodayTasks = todayTasks.length;

    if (totalTodayTasks > 0) {
      dailyLog.daily_progress = Math.round(
        (completedTodayTasks / totalTodayTasks) * 100
      );
      console.log(
        `ðŸ“… Daily progress for ${today}: ${dailyLog.daily_progress}% (${completedTodayTasks}/${totalTodayTasks})`
      );
    }
  } else {
    console.warn(
      `âš ï¸ No currentStageTracking found for stage ${notebook.current_stage}`
    );
  }

  // âœ… Kiá»ƒm tra xem stage hiá»‡n táº¡i Ä‘Ã£ hoÃ n thÃ nh 100% chÆ°a
  // Náº¿u cÃ³, mark stage as completed vÃ  tá»± Ä‘á»™ng chuyá»ƒn sang stage tiáº¿p theo
  if (currentStageTracking && notebook.template_id) {
    const stageCompletion = await notebook.getCurrentStageCompletion();
    console.log(`ðŸŽ¯ Current stage completion: ${stageCompletion}%`);

    if (stageCompletion >= 100 && !currentStageTracking.completed_at) {
      // Mark stage as completed
      currentStageTracking.completed_at = new Date();
      console.log(`âœ… Stage ${notebook.current_stage} marked as COMPLETED`);

      // Cáº­p nháº­t láº¡i plant progress
      await notebook.updateProgress(notebook.template_id.stages);
      console.log(`ðŸŒ± Plant progress updated: ${notebook.progress}%`);

      // TODO: Tá»± Ä‘á»™ng chuyá»ƒn sang stage tiáº¿p theo (náº¿u cÃ³)
      // const nextStageNumber = notebook.current_stage + 1;
      // if (nextStageNumber <= notebook.template_id.stages.length) {
      //   await updateCurrentStage(notebookId, nextStageNumber);
      // }
    }
  }

  await notebook.save();

  return notebook;
};

// Láº¥y táº¥t cáº£ observations cá»§a stage hiá»‡n táº¡i
export const getCurrentStageObservations = async (notebookId) => {
  const notebook = await Notebook.findById(notebookId).populate("template_id");

  if (!notebook || !notebook.template_id) {
    return [];
  }

  const template = notebook.template_id;
  const currentStage = template.stages.find(
    (s, index) => index + 1 === notebook.current_stage
  );

  return currentStage ? currentStage.observations : [];
};

// Cáº­p nháº­t observation cho stage hiá»‡n táº¡i
export const updateStageObservation = async (
  notebookId,
  observationKey,
  value
) => {
  const notebook = await Notebook.findById(notebookId);

  if (!notebook) {
    throw new AppError("KhÃ´ng tÃ¬m tháº¥y nháº­t kÃ½", 404);
  }

  const stageTracking = notebook.stages_tracking.find(
    (s) => s.stage_number === notebook.current_stage
  );

  if (!stageTracking) {
    throw new AppError("KhÃ´ng tÃ¬m tháº¥y stage tracking", 404);
  }

  // TÃ¬m hoáº·c táº¡o má»›i observation
  const existingObs = stageTracking.observations.find(
    (o) => o.key === observationKey
  );

  if (existingObs) {
    existingObs.value = value;
    existingObs.observed_at = new Date();
  } else {
    stageTracking.observations.push({
      key: observationKey,
      value: value,
      observed_at: new Date(),
    });
  }

  await notebook.save();
  return notebook;
};

// Kiá»ƒm tra xem cÃ³ nÃªn tá»± Ä‘á»™ng chuyá»ƒn stage khÃ´ng (dá»±a trÃªn rules)
export const checkAutoStageTransition = async (notebookId) => {
  const notebook = await Notebook.findById(notebookId).populate("template_id");

  if (!notebook || !notebook.template_id) {
    return false;
  }

  const template = notebook.template_id;
  const currentStageTracking = notebook.stages_tracking.find(
    (s) => s.stage_number === notebook.current_stage
  );

  if (!currentStageTracking) {
    return false;
  }

  // Kiá»ƒm tra rules: auto_skip_stages
  if (template.rules && template.rules.auto_skip_stages) {
    for (const skipRule of template.rules.auto_skip_stages) {
      // Náº¿u cÃ³ observation match vá»›i Ä‘iá»u kiá»‡n skip
      const matchedObs = currentStageTracking.observations.find(
        (o) => o.key === skipRule.observation_key && o.value === true
      );

      if (matchedObs && skipRule.skip_to_stage) {
        // Auto chuyá»ƒn sang stage chá»‰ Ä‘á»‹nh
        await updateCurrentStage(notebookId, skipRule.skip_to_stage);
        return true;
      }
    }
  }

  return false;
};

// Láº¥y timeline cho notebook (táº¥t cáº£ stages vá»›i thá»i gian)
export const getNotebookTimeline = async (notebookId) => {
  // Validate notebookId
  if (!notebookId || notebookId === "undefined" || notebookId === "null") {
    throw new AppError("Invalid notebook ID", 400);
  }

  const notebook = await Notebook.findById(notebookId).populate("template_id");

  if (!notebook || !notebook.template_id) {
    return null;
  }

  const template = notebook.template_id;

  const timeline = notebook.stages_tracking.map((tracking) => {
    const templateStage = template.stages.find(
      (s, idx) => idx + 1 === tracking.stage_number
    );

    return {
      stage_number: tracking.stage_number,
      stage_name: tracking.stage_name,
      started_at: tracking.started_at,
      completed_at: tracking.completed_at,
      is_current: tracking.is_current,
      duration_days: templateStage
        ? templateStage.day_end - templateStage.day_start + 1
        : null,
      start_day: templateStage ? templateStage.day_start : null,
      end_day: templateStage ? templateStage.day_end : null,
      observations: tracking.observations,
    };
  });

  return {
    planted_date: notebook.planted_date,
    current_day: notebook.current_day,
    progress: notebook.progress,
    total_days: template.total_days,
    timeline,
  };
};
